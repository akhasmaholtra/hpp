<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software Pastry Pro: HPP & Timer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* =========================================================
           GLOBAL STYLES (Kalkulator & App Shell)
        ========================================================= */
        :root {
            --dark-navy: #14213d;
            --gold: #fca311;
            --black: #000000;
            --light-gray: #e5e5e5;
            --white: #ffffff;
        }
        body { font-family: 'Poppins', sans-serif; background: #f9fafb; }
        .card-shadow { box-shadow: 0 10px 40px rgba(139, 90, 43, 0.08); }
        
        /* Taskbar / Main Nav */
        .main-taskbar {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .taskbar-btn {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
        }
        .taskbar-btn:hover { color: #d97706; background: #fffbeb; }
        .taskbar-btn.active {
            color: #d97706;
            border-bottom-color: #d97706;
            background: #fffbeb;
        }

        /* Auth screens */
        #authWrapper {
            min-height: 100vh;
            background: linear-gradient(135deg, #78350f 0%, #b45309 50%, #d97706 100%);
            display: flex;
            align-items: center; justify-content: center; padding: 1rem;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999;
        }
        .auth-card { background: white; border-radius: 24px; padding: 2.5rem; width: 100%; max-width: 440px; box-shadow: 0 25px 60px rgba(0,0,0,0.3); }
        .auth-input { width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 12px; font-family: 'Poppins', sans-serif; outline: none; }
        .auth-input:focus { border-color: #d97706; }
        .auth-btn { width: 100%; padding: 0.875rem; background: linear-gradient(135deg, #b45309, #d97706); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .tab-btn { flex: 1; padding: 0.625rem; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; background: transparent; color: #9ca3af; }
        .tab-btn.active { background: white; color: #92400e; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .otp-display { background: #fffbeb; border: 2px dashed #d97706; border-radius: 12px; padding: 1rem; text-align: center; font-size: 1.75rem; font-weight: 700; letter-spacing: 0.5rem; color: #92400e; }

        /* =========================================================
           TIMER STYLES (Dari kodemu)
        ========================================================= */
        .glass { background: rgba(255,255,255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(20, 33, 61, 0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .ringPulse { animation: ringPulse 1.1s ease-in-out infinite; }
        @keyframes ringPulse { 0%,100%{ transform: translateZ(0) scale(1); box-shadow: 0 0 0 0 rgba(252, 163, 17, 0.4); } 50%{ transform: translateZ(0) scale(1.01); box-shadow: 0 0 0 10px rgba(252, 163, 17, 0.1); } }
        .toastIn { animation: toastIn .22s ease-out both; }
        @keyframes toastIn { from{ transform: translateY(10px); opacity:0;} to{ transform: translateY(0); opacity:1;} }
        
        .scroll-picker { height: 120px; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .scroll-picker::-webkit-scrollbar { display: none; }
        .scroll-picker-item { height: 40px; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: bold; color: #999; transition: all 0.15s; }
        .scroll-picker-item.active { color: var(--dark-navy); font-size: 1.5rem; }
        .picker-highlight { position: absolute; top: 50%; left: 0; right: 0; height: 40px; transform: translateY(-50%); background: rgba(252, 163, 17, 0.08); border-radius: 8px; pointer-events: none; }
        
        .nav-item-timer { transition: all 0.2s; color: var(--black); cursor: pointer; }
        .nav-item-timer.active { background: rgba(252, 163, 17, 0.12); color: var(--gold) !important; border-radius: 8px; }
        
        .calc-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .calc-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .calc-btn:active { transform: translateY(0) scale(0.98); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .calc-history-item:hover { background: rgba(252, 163, 17, 0.1); transform: translateX(-4px); cursor: pointer; }
        
        /* Calculator Sub-Taskbar */
        .calc-nav-btn {
            padding: 0.5rem 1rem; border-radius: 0.75rem; font-size: 0.9rem; font-weight: 600; color: #6b7280; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .calc-nav-btn:hover { background-color: #fff7ed; color: #d97706; transform: translateY(-1px); }
        .calc-nav-btn.active { background-color: #fff7ed; color: #d97706; box-shadow: 0 2px 4px rgba(217, 119, 6, 0.1); }
        .calc-nav-btn.active span { transform: scale(1.1); }
        
        .ripple { position: relative; overflow: hidden; }
        .ripple::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.5); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .ripple:active::after { width: 200px; height: 200px; }
    </style>
</head>
<body class="min-h-dvh">

<div id="authWrapper">
    <div class="auth-card">
        <div class="text-center mb-6">
            <div class="text-5xl mb-2">ü•ê</div>
            <h1 class="text-2xl font-bold text-amber-900">Pastry Pro Suite</h1>
            <p class="text-gray-500 text-sm mt-1">Kalkulator HPP & Professional Timer</p>
        </div>

        <div class="flex bg-gray-100 rounded-xl p-1 mb-6">
            <button class="tab-btn active" id="tabAktivasi" onclick="switchAuthTab('aktivasi')">üîë Aktivasi</button>
            <button class="tab-btn" id="tabMasuk" onclick="switchAuthTab('masuk')">üìß Masuk</button>
        </div>

        <div id="alertBox" class="p-3 mb-4 rounded-lg text-sm hidden font-medium"></div>

        <div id="panelAktivasi">
            <div class="space-y-4">
                <input type="email" id="aktEmail" class="auth-input" placeholder="Email (cth: kamu@gmail.com)">
                <input type="text" id="aktKey" class="auth-input" placeholder="License Key (PRO-CHEF-...)" style="text-transform: uppercase;">
                <button class="auth-btn" onclick="doAktivasi()">‚ú® Aktifkan Akses</button>
            </div>
            <div class="mt-4 p-3 bg-amber-50 rounded-xl text-xs text-amber-800 border border-amber-200">
                üéÅ Demo Keys: PRO-CHEF-77X9 | PRO-CHEF-22B4
            </div>
        </div>

        <div id="panelMasuk" style="display:none;">
            <div id="masukStep1">
                <div class="space-y-4">
                    <input type="email" id="masukEmail" class="auth-input" placeholder="Email terdaftar">
                    <button class="auth-btn" onclick="kirimOTP()">üì§ Kirim Kode OTP</button>
                </div>
            </div>
            <div id="masukStep2" style="display:none;">
                <div class="otp-display mb-4" id="otpDisplay">------</div>
                <div class="space-y-4">
                    <input type="text" id="otpInput" class="auth-input text-center text-xl font-bold tracking-widest" placeholder="123456" maxlength="6">
                    <button class="auth-btn" onclick="verifikasiOTP()">‚úÖ Verifikasi</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="mainApp" style="display:none;">
    
    <nav class="main-taskbar flex items-center justify-between px-4 md:px-8">
        <div class="flex items-center gap-2 py-3">
            <span class="text-2xl">ü•ê</span>
            <h1 class="font-bold text-amber-900 hidden md:block">Pastry Pro</h1>
        </div>
        <div class="flex">
            <button class="taskbar-btn active" id="navKalkulator" onclick="switchMainTab('kalkulator')">üßÆ Kalkulator</button>
            <button class="taskbar-btn" id="navDatabase" onclick="switchMainTab('database')">üìö Database</button>
            <button class="taskbar-btn" id="navTimer" onclick="switchMainTab('timer')">‚è±Ô∏è Timer</button>
        </div>
        <div class="py-3">
            <button onclick="logout()" class="text-sm text-red-500 font-medium hover:underline">Keluar</button>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto p-4 py-8">

        <div id="tabKalkulator" class="main-content-tab">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-amber-800">Kalkulator HPP Pastry<br>khusus Yota</h1>
                <p class="text-amber-700">Hitung Harga Pokok Produksi dengan mudah</p>
            </div>

            <div class="mb-6 bg-white p-4 rounded-xl card-shadow border-l-4 border-amber-600">
                <label class="block text-amber-900 font-bold mb-2">Nama Produk / Menu:</label>
                <input type="text" id="namaProduk" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:border-amber-500 outline-none" placeholder="Contoh: Croissant Butter 50gr">
            </div>

            <!-- Calculator Sub-Taskbar -->
            <div class="sticky top-[80px] z-30 bg-white/90 backdrop-blur-md shadow-sm rounded-2xl mb-6 p-1.5 flex justify-between md:justify-center gap-1 md:gap-4 border border-gray-100 transition-all duration-300" id="calcTaskbar">
                <button onclick="scrollToSection('secBahan')" class="calc-nav-btn flex-1 md:flex-none active" data-target="secBahan"><span>üõí</span> <span class="hidden sm:inline">Bahan</span></button>
                <button onclick="scrollToSection('secResep')" class="calc-nav-btn flex-1 md:flex-none" data-target="secResep"><span>ü•£</span> <span class="hidden sm:inline">Resep</span></button>
                <button onclick="scrollToSection('secHasil')" class="calc-nav-btn flex-1 md:flex-none" data-target="secHasil"><span>üí∞</span> <span class="hidden sm:inline">Hasil</span></button>
                <button onclick="scrollToSection('historyPanel')" class="calc-nav-btn flex-1 md:flex-none" data-target="historyPanel"><span>üìú</span> <span class="hidden sm:inline">Riwayat</span></button>
            </div>

            <div id="secBahan" class="bg-white rounded-2xl card-shadow p-6 mb-6 border-l-4 border-amber-500 scroll-mt-36">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="bg-amber-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</span>
                        <h2 class="text-xl font-semibold text-amber-800">Input Bahan Resep</h2>
                    </div>
                    <button onclick="switchMainTab('database')" class="text-sm bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg font-medium hover:bg-purple-200 transition">
                        üìö Cari di Database
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full" id="bahanTable">
                        <thead>
                            <tr class="bg-amber-50 text-amber-800 text-sm">
                                <th class="p-3 text-left rounded-l-lg">Nama Bahan</th>
                                <th class="p-3 text-center">Berat Beli (gr)</th>
                                <th class="p-3 text-center">Harga Beli (Rp)</th>
                                <th class="p-3 text-center bg-amber-100">Harga/gr</th>
                                <th class="p-3 text-center rounded-r-lg">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bahanBody"></tbody>
                    </table>
                </div>
                <button onclick="tambahBahanKalkulator()" class="mt-4 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium transition">+ Tambah Baris Kosong</button>
            </div>

            <div id="secResep" class="bg-white rounded-2xl card-shadow p-6 mb-6 border-l-4 border-green-500 scroll-mt-36">
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">2</span>
                    <h2 class="text-xl font-semibold text-green-800">Gramasi Resep</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full" id="resepTable">
                        <thead>
                            <tr class="bg-green-50 text-green-800 text-sm">
                                <th class="p-3 text-left rounded-l-lg">Bahan</th>
                                <th class="p-3 text-center">Berat Beli</th>
                                <th class="p-3 text-center">Harga/gr</th>
                                <th class="p-3 text-center">Berat Resep (gr)</th>
                                <th class="p-3 text-center bg-green-100">Biaya Bahan</th>
                                <th class="p-3 text-center rounded-r-lg">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="resepBody"></tbody>
                    </table>
                </div>
                
                <div class="mt-4 bg-green-50 rounded-xl p-4 flex justify-between items-center">
                    <span class="text-green-800 font-semibold">Total Biaya Bahan:</span>
                    <span class="text-2xl font-bold text-green-700" id="totalBiayaKalkulator">Rp 0</span>
                </div>
            </div>

            <div id="secHasil" class="bg-white rounded-2xl card-shadow p-6 border-l-4 border-blue-500 scroll-mt-36">
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">3</span>
                    <h2 class="text-xl font-semibold text-blue-800">Final HPP</h2>
                </div>
                <div class="grid md:grid-cols-2 gap-6 items-end">
                    <div>
                        <label class="block text-blue-800 font-medium mb-2">Jumlah Unit Hasil Produksi</label>
                        <input type="number" id="jumlahUnitKalkulator" placeholder="Contoh: 10" min="1" class="w-full px-4 py-3 border-2 border-blue-200 rounded-xl focus:border-blue-500 outline-none" oninput="hitungHPP()">
                    </div>
                    <button onclick="resetKalkulator()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium">üîÑ Kosongkan Kalkulator</button>
                </div>
                <div class="mt-6 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white text-center">
                    <p class="text-blue-100 mb-2">HPP Per Unit</p>
                    <p class="text-5xl font-bold" id="hppPerUnit">Rp 0</p>
                    <div class="mt-4 flex justify-center gap-3">
                        <button onclick="saveHistory()" class="px-4 py-2 bg-white text-blue-700 rounded-lg font-semibold shadow hover:opacity-90">üíæ Simpan Riwayat</button>
                        <button onclick="downloadPDF()" class="px-4 py-2 bg-amber-400 text-amber-900 rounded-lg font-semibold shadow hover:bg-amber-300">üìÑ Download PDF</button>
                    </div>
                </div>
            </div>

            <div id="historyPanel" class="mt-8 bg-white rounded-2xl card-shadow p-6 border-l-4 border-gray-400 scroll-mt-36">
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-gray-400 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">R</span>
                    <h2 class="text-xl font-semibold text-gray-800">Riwayat Kalkulasi</h2>
                </div>
                <p class="text-gray-600 text-sm mb-4">Riwayat menyimpan snapshot kalkulasi. Disimpan di browser Anda.</p>
                <div id="historyList" class="space-y-3"></div>
                <div class="mt-4 flex gap-3">
                    <button onclick="clearHistory()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">üóëÔ∏è Hapus Semua Riwayat</button>
                </div>
            </div>
        </div>

        <div id="tabDatabase" class="main-content-tab hidden">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-purple-800">Database Master Bahan</h1>
                <p class="text-purple-700">Simpan daftar bahan baku yang sering kamu gunakan di sini.</p>
            </div>

            <div class="bg-white rounded-2xl card-shadow p-6 mb-6 border-l-4 border-purple-500">
                <h2 class="font-bold text-lg mb-4 text-purple-900">Tambah Bahan Baru</h2>
                <div class="flex flex-wrap gap-3 mb-6 bg-purple-50 p-4 rounded-xl border border-purple-100">
                    <input type="text" id="dbNama" placeholder="Nama Bahan (Cth: Susu UHT)" class="flex-1 min-w-[200px] px-3 py-2 border border-purple-200 rounded-lg outline-none focus:border-purple-500">
                    <input type="number" id="dbBerat" placeholder="Berat Beli (gr)" class="w-32 px-3 py-2 border border-purple-200 rounded-lg text-center outline-none focus:border-purple-500">
                    <input type="number" id="dbHarga" placeholder="Harga Beli (Rp)" class="w-40 px-3 py-2 border border-purple-200 rounded-lg text-center outline-none focus:border-purple-500">
                    <button onclick="simpanKeDatabase()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition">üíæ Simpan Data</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-purple-100 text-purple-800">
                                <th class="p-3 text-left rounded-l-lg">Nama Bahan</th>
                                <th class="p-3 text-center">Berat (gr)</th>
                                <th class="p-3 text-center">Harga Beli</th>
                                <th class="p-3 text-center bg-purple-200">Harga/gr</th>
                                <th class="p-3 text-center rounded-r-lg">Gunakan di Kalkulator</th>
                            </tr>
                        </thead>
                        <tbody id="dbTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabTimer" class="main-content-tab hidden">
            
            <nav class="mb-6 rounded-2xl glass border border-gray-200/50 overflow-hidden" style="background: linear-gradient(90deg, #14213d 0%, #1c2e55 100%);">
                <div class="flex items-center gap-1 overflow-x-auto p-2">
                    <button data-nav="quick" class="nav-item-timer active px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap" style="color: #ffffff;">‚ö° Quick</button>
                    <button data-nav="main" class="nav-item-timer px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap" style="color: #ffffff;">Multi Timer</button>
                    <button data-nav="simple" class="nav-item-timer px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap" style="color: #ffffff;">Timer Simpel</button>
                    <button data-nav="calc" class="nav-item-timer px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap" style="color: #ffffff;">Kalkulator</button>
                </div>
            </nav>

            <div id="pageQuick" class="page-timer">
                <div class="mx-auto max-w-lg">
                    <div id="quickTimerCard" class="glass rounded-3xl p-6 shadow-lg">
                        <div id="quickDisplay" class="text-6xl md:text-7xl font-black text-center py-8 tracking-tight" style="color: #14213d;">00:00</div>
                        <div class="grid grid-cols-4 gap-2 mb-4">
                            <button class="quick-add px-3 py-3 rounded-xl font-bold text-sm" style="background: rgba(252,163,17,0.15); color: #14213d; border: 1px solid rgba(252,163,17,0.3);" data-sec="5">+5s</button>
                            <button class="quick-add px-3 py-3 rounded-xl font-bold text-sm" style="background: rgba(252,163,17,0.15); color: #14213d; border: 1px solid rgba(252,163,17,0.3);" data-sec="10">+10s</button>
                            <button class="quick-add px-3 py-3 rounded-xl font-bold text-sm" style="background: rgba(252,163,17,0.15); color: #14213d; border: 1px solid rgba(252,163,17,0.3);" data-sec="30">+30s</button>
                            <button class="quick-add px-3 py-3 rounded-xl font-bold text-sm" style="background: rgba(252,163,17,0.15); color: #14213d; border: 1px solid rgba(252,163,17,0.3);" data-sec="60">+1m</button>
                        </div>
                        <div class="h-3 rounded-full overflow-hidden mb-6" style="background: rgba(228,229,229,0.6);">
                            <div id="quickBar" class="h-full transition-all duration-300" style="background: linear-gradient(90deg, #fca311, #14213d); width:0%;"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <button id="quickStart" class="px-4 py-4 rounded-2xl text-white font-bold text-lg" style="background: #fca311;">‚ñ∂ Start</button>
                            <button id="quickPause" class="hidden px-4 py-4 rounded-2xl text-white font-bold text-lg" style="background: #14213d;">‚è∏ Pause</button>
                            <button id="quickReset" class="px-4 py-4 rounded-2xl font-bold text-lg" style="background: rgba(228,229,229,0.9); color: #14213d;">‚Ü∫ Reset</button>
                            <button id="quickStop" class="hidden px-4 py-4 rounded-2xl text-white font-bold text-lg" style="background: #14213d;">‚¨õ Stop</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pageMain" class="page-timer hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Multi-Alarm Timer</h2>
                    <div class="flex gap-2">
                        <button id="btnNotif" class="px-3 py-2 rounded-xl glass shadow-sm text-sm font-semibold">üîî Notif</button>
                        <button id="btnMute" class="px-3 py-2 rounded-xl glass shadow-sm text-sm font-semibold">üîä ON</button>
                        <button id="btnStopAll" class="px-3 py-2 rounded-xl text-white shadow-sm text-sm font-semibold bg-red-600">Stop Semua</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                    <div class="lg:col-span-4 glass rounded-2xl p-4">
                        <h2 class="font-bold text-lg mb-4 text-gray-800">Tambah Timer</h2>
                        <input id="inName" class="w-full rounded-xl px-3 py-2 border mb-3 bg-gray-50 outline-none" placeholder="Nama: Croissant batch 2">
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <select id="inCategory" class="rounded-xl px-3 py-2 border bg-gray-50 outline-none"><option>Baking</option><option>Proofing</option><option>Mixing</option></select>
                            <select id="inTheme" class="rounded-xl px-3 py-2 border bg-gray-50 outline-none"><option value="vanilla">Vanilla</option><option value="choco">Choco</option><option value="strawberry">Strawberry</option></select>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div class="relative rounded-xl border overflow-hidden bg-gray-50"><div class="picker-highlight"></div><div class="text-center text-[10px] pt-1 text-gray-400">Jam</div><div id="pickH" class="scroll-picker"></div></div>
                            <div class="relative rounded-xl border overflow-hidden bg-gray-50"><div class="picker-highlight"></div><div class="text-center text-[10px] pt-1 text-gray-400">Menit</div><div id="pickM" class="scroll-picker"></div></div>
                            <div class="relative rounded-xl border overflow-hidden bg-gray-50"><div class="picker-highlight"></div><div class="text-center text-[10px] pt-1 text-gray-400">Detik</div><div id="pickS" class="scroll-picker"></div></div>
                        </div>
                        <button id="btnAddTimer" class="w-full px-4 py-3 rounded-xl text-white font-bold bg-amber-500">Tambah ke Daftar</button>
                    </div>
                    <div class="lg:col-span-8 glass rounded-2xl p-4">
                        <div id="emptyTimer" class="p-6 text-center text-gray-500 border rounded-xl border-dashed">Belum ada timer aktif.</div>
                        <div id="timerList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                    </div>
                </div>
            </div>

            <div id="pageSimple" class="page-timer hidden">
                <div class="max-w-xl mx-auto">
                    <div class="glass p-6 rounded-3xl text-center">
                        <p class="text-gray-500 mb-4">Fitur Simple Timer disederhanakan ke dalam layar Quick & Multi Timer agar aplikasi lebih ringan.</p>
                        <button onclick="document.querySelector('[data-nav=\'main\']').click()" class="px-4 py-2 bg-amber-500 text-white rounded-lg font-bold">Gunakan Multi Timer</button>
                    </div>
                </div>
            </div>

            <div id="pageCalc" class="page-timer hidden">
                <div class="mx-auto max-w-sm">
                    <div class="glass rounded-3xl p-5 shadow-lg">
                        <input id="calcDisplay" type="text" readonly class="w-full text-right text-4xl font-bold rounded-xl px-4 py-4 mb-4 border bg-gray-50 text-gray-800" value="0">
                        <div class="grid grid-cols-4 gap-2">
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-200" data-calc="C">C</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-200" data-calc="%">%</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-200" data-calc="¬±">¬±</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-amber-500 text-white" data-calc="/">√∑</button>
                            
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="7">7</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="8">8</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="9">9</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-amber-500 text-white" data-calc="*">√ó</button>
                            
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="4">4</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="5">5</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="6">6</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-amber-500 text-white" data-calc="-">‚àí</button>
                            
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="1">1</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="2">2</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="3">3</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-amber-500 text-white" data-calc="+">+</button>
                            
                            <button class="calc-btn col-span-2 px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc="0">0</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-100" data-calc=".">.</button>
                            <button class="calc-btn px-4 py-4 rounded-xl font-bold text-lg bg-gray-800 text-white" data-calc="=">=</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="toasts" class="fixed bottom-20 left-1/2 -translate-x-1/2 w-[min(400px,90vw)] space-y-2 z-50"></div>
        </div>

    </div>
</div>

<script>
/* =========================================================================
   SISTEM AUTENTIKASI (LOGIN & SESSION)
========================================================================= */
const DB_KEY = 'pastryPro_db';
const SESS_KEY = 'pastryPro_session';
const OTP_KEY = 'pastryPro_otp';
const VALID_KEYS = ['PRO-CHEF-77X9', 'PRO-CHEF-22B4', 'PRO-CHEF-55K1'];

function getLicenseDB() {
    let db = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
    VALID_KEYS.forEach(k => { if (!db[k]) db[k] = { status: 'unused', email: null }; });
    return db;
}
function saveLicenseDB(db) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function showAlert(msg, isError = true) {
    const el = document.getElementById('alertBox');
    el.textContent = msg;
    el.className = `p-3 mb-4 rounded-lg text-sm font-medium ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
    el.style.display = 'block';
}
function hideAlert() { document.getElementById('alertBox').style.display = 'none'; }
function switchAuthTab(tab) {
    hideAlert();
    document.getElementById('panelAktivasi').style.display = tab === 'aktivasi' ? 'block' : 'none';
    document.getElementById('panelMasuk').style.display = tab === 'masuk' ? 'block' : 'none';
    document.getElementById('tabAktivasi').classList.toggle('active', tab === 'aktivasi');
    document.getElementById('tabMasuk').classList.toggle('active', tab === 'masuk');
}
function doAktivasi() {
    const email = document.getElementById('aktEmail').value.trim().toLowerCase();
    const key = document.getElementById('aktKey').value.trim().toUpperCase();
    if (!email.includes('@')) return showAlert('Email tidak valid.');
    const db = getLicenseDB();
    if (!db[key]) return showAlert('License Key salah.');
    if (db[key].status === 'used' && db[key].email !== email) return showAlert('Key sudah dipakai akun lain.');
    
    db[key].status = 'used'; db[key].email = email;
    saveLicenseDB(db);
    showAlert('Aktivasi Berhasil!', false);
    setTimeout(() => loginSuccess(email), 1000);
}
function kirimOTP() {
    const email = document.getElementById('masukEmail').value.trim().toLowerCase();
    const isReg = Object.values(getLicenseDB()).some(v => v.email === email && v.status === 'used');
    if (!isReg) return showAlert('Email belum aktivasi.');
    
    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem(OTP_KEY, JSON.stringify({ email, otp }));
    document.getElementById('masukStep1').style.display = 'none';
    document.getElementById('masukStep2').style.display = 'block';
    document.getElementById('otpDisplay').textContent = otp; // Demo
    showAlert('OTP Simulasi Terkirim!', false);
}
function verifikasiOTP() {
    const input = document.getElementById('otpInput').value;
    const data = JSON.parse(localStorage.getItem(OTP_KEY) || '{}');
    if (input !== data.otp) return showAlert('OTP Salah!');
    localStorage.removeItem(OTP_KEY);
    loginSuccess(data.email);
}
function loginSuccess(email) {
    localStorage.setItem(SESS_KEY, JSON.stringify({ email, expiry: Date.now() + 8640000000 }));
    document.getElementById('authWrapper').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    initApp();
}
function logout() {
    localStorage.removeItem(SESS_KEY);
    location.reload();
}
document.addEventListener('DOMContentLoaded', () => {
    const sess = JSON.parse(localStorage.getItem(SESS_KEY) || 'null');
    if (sess && sess.expiry > Date.now()) {
        document.getElementById('authWrapper').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        initApp();
    }
});

/* =========================================================================
   SISTEM NAVIGASI GLOBAL (TASKBAR)
========================================================================= */
function switchMainTab(tabId) {
    // Sembunyikan semua tab
    document.querySelectorAll('.main-content-tab').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.taskbar-btn').forEach(el => el.classList.remove('active'));
    
    // Tampilkan yang dipilih
    let target = document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
    if(target) target.classList.remove('hidden');
    
    let btn = document.getElementById('nav' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
    if(btn) btn.classList.add('active');
}

/* =========================================================================
   DATABASE BAHAN BAKU LOGIC
========================================================================= */
let masterDB = [];
function loadMasterDB() { masterDB = JSON.parse(localStorage.getItem('pastryPro_MasterBahan') || '[]'); renderMasterDB(); }
function saveMasterDB() { localStorage.setItem('pastryPro_MasterBahan', JSON.stringify(masterDB)); }
function simpanKeDatabase() {
    let nama = document.getElementById('dbNama').value.trim();
    let berat = parseFloat(document.getElementById('dbBerat').value) || 0;
    let harga = parseFloat(document.getElementById('dbHarga').value) || 0;
    if (!nama || berat <= 0 || harga <= 0) return alert('Isi data dengan benar!');
    masterDB.push({ id: Date.now(), nama, berat, harga, hpp: harga/berat });
    saveMasterDB(); renderMasterDB();
    document.getElementById('dbNama').value = ''; document.getElementById('dbBerat').value = ''; document.getElementById('dbHarga').value = '';
}
function renderMasterDB() {
    const tbody = document.getElementById('dbTbody');
    if (masterDB.length === 0) return tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">Database kosong.</td></tr>`;
    tbody.innerHTML = masterDB.map(b => `
        <tr class="border-b border-purple-100 hover:bg-purple-50">
            <td class="p-3 font-medium">${b.nama}</td>
            <td class="p-3 text-center">${b.berat} gr</td>
            <td class="p-3 text-center">Rp ${b.harga.toLocaleString('id-ID')}</td>
            <td class="p-3 text-center font-bold text-purple-700">Rp ${b.hpp.toFixed(1)}</td>
            <td class="p-3 text-center">
                <button onclick="pindahkanKeKalkulator(${b.id})" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-1.5 rounded font-medium shadow-sm transition">‚ûï Pakai</button>
            </td>
        </tr>
    `).join('');
}
function pindahkanKeKalkulator(id) {
    const bahan = masterDB.find(b => b.id === id);
    if (!bahan) return;
    
    // Cari baris kosong di kalkulator
    let targetRow = bahanKalkulator.find(b => b.nama === '' && b.berat === 0);
    if (targetRow) {
        targetRow.nama = bahan.nama; targetRow.berat = bahan.berat; targetRow.harga = bahan.harga; targetRow.hpp = bahan.hpp;
    } else {
        bahanKalkulator.push({ id: Date.now() + Math.random(), nama: bahan.nama, berat: bahan.berat, harga: bahan.harga, hpp: bahan.hpp });
    }
    
    renderKalkulator();
    switchMainTab('kalkulator'); // PINDAH TAB OTOMATIS
}

/* =========================================================================
   KALKULATOR HPP LOGIC
========================================================================= */
let bahanKalkulator = [];
let resepKalkulator = {}; // { bahanId: beratResep }

function tambahBahanKalkulator() {
    bahanKalkulator.push({ id: Date.now(), nama: '', berat: 0, harga: 0, hpp: 0 });
    renderKalkulator();
}
function ubahBahan(id, field, value) {
    let b = bahanKalkulator.find(x => x.id === id);
    if(b) {
        b[field] = value;
        if (b.berat > 0 && b.harga > 0) b.hpp = b.harga / b.berat;
        renderKalkulator();
    }
}
function hapusBahanKalkulator(id) {
    bahanKalkulator = bahanKalkulator.filter(x => x.id !== id);
    delete resepKalkulator[id];
    renderKalkulator();
}
function ubahResep(id, value) {
    resepKalkulator[id] = parseFloat(value) || 0;
    renderKalkulator();
}
function renderKalkulator() {
    // Tabel 1
    document.getElementById('bahanBody').innerHTML = bahanKalkulator.map(b => `
        <tr class="border-b border-amber-100 bg-white">
            <td class="p-2"><input class="w-full border p-2 rounded" placeholder="Nama..." value="${b.nama}" onchange="ubahBahan(${b.id}, 'nama', this.value)"></td>
            <td class="p-2"><input class="w-full border p-2 rounded text-center" type="number" placeholder="0" value="${b.berat || ''}" onchange="ubahBahan(${b.id}, 'berat', parseFloat(this.value))"></td>
            <td class="p-2"><input class="w-full border p-2 rounded text-center" type="number" placeholder="0" value="${b.harga || ''}" onchange="ubahBahan(${b.id}, 'harga', parseFloat(this.value))"></td>
            <td class="p-2 text-center font-bold text-amber-700">Rp ${b.hpp.toFixed(1)}</td>
            <td class="p-2 text-center"><button onclick="hapusBahanKalkulator(${b.id})" class="text-red-500 font-bold hover:bg-red-50 px-2 py-1 rounded">X</button></td>
        </tr>
    `).join('');

    // Tabel 2 (Resep)
    let totalBiaya = 0;
    const resepHTML = bahanKalkulator.filter(b => b.nama).map(b => {
        let pakai = resepKalkulator[b.id] || 0;
        let biaya = b.hpp * pakai;
        totalBiaya += biaya;
        return `
            <tr class="border-b border-green-100 bg-white">
                <td class="p-3 font-medium text-gray-700">${b.nama}</td>
                <td class="p-3 text-center text-gray-500">${b.berat} gr</td>
                <td class="p-3 text-center text-gray-500">Rp ${b.hpp.toFixed(1)}</td>
                <td class="p-3"><input type="number" class="w-full border p-2 rounded text-center border-green-300" placeholder="gr" value="${pakai || ''}" onchange="ubahResep(${b.id}, this.value)"></td>
                <td class="p-3 text-center font-bold text-green-700">Rp ${Math.round(biaya).toLocaleString('id-ID')}</td>
                <td class="p-3 text-center"><button onclick="hapusBahanKalkulator(${b.id})" class="text-red-500 hover:text-red-700 font-bold" title="Hapus dari resep">üóëÔ∏è</button></td>
            </tr>
        `;
    });
    
    document.getElementById('resepBody').innerHTML = resepHTML.length ? resepHTML.join('') : `<tr><td colspan="6" class="text-center p-4 text-gray-400">Isi bahan di tabel atas dulu</td></tr>`;
    document.getElementById('totalBiayaKalkulator').textContent = 'Rp ' + Math.round(totalBiaya).toLocaleString('id-ID');
    hitungHPP();
}
function hitungHPP() {
    let totalBiaya = bahanKalkulator.reduce((sum, b) => sum + (b.hpp * (resepKalkulator[b.id] || 0)), 0);
    let unit = parseFloat(document.getElementById('jumlahUnitKalkulator').value) || 1;
    document.getElementById('hppPerUnit').textContent = 'Rp ' + Math.round(totalBiaya / unit).toLocaleString('id-ID');
}
function resetKalkulator() {
    if(confirm('Reset area kalkulator? (Database tetap aman)')) {
        bahanKalkulator = []; resepKalkulator = {};
        document.getElementById('namaProduk').value = '';
        document.getElementById('jumlahUnitKalkulator').value = '';
        for(let i=0; i<3; i++) tambahBahanKalkulator();
    }
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const namaProduk = document.getElementById('namaProduk').value || 'Tanpa Nama';
    const unit = document.getElementById('jumlahUnitKalkulator').value || 1;
    const totalBiaya = document.getElementById('totalBiayaKalkulator').textContent;
    const hpp = document.getElementById('hppPerUnit').textContent;

    doc.setFontSize(18);
    doc.text("Laporan HPP - Pastry Pro", 14, 20);
    
    doc.setFontSize(12);
    doc.text(`Produk: ${namaProduk}`, 14, 30);
    doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 36);

    const headers = [["Bahan", "Berat Resep", "Harga/gr", "Total Biaya"]];
    const data = bahanKalkulator.filter(b => b.nama).map(b => {
        const pakai = resepKalkulator[b.id] || 0;
        const biaya = b.hpp * pakai;
        return [b.nama, pakai + ' gr', 'Rp ' + b.hpp.toFixed(1), 'Rp ' + Math.round(biaya).toLocaleString('id-ID')];
    });

    doc.autoTable({ startY: 45, head: headers, body: data, theme: 'grid', headStyles: { fillColor: [217, 119, 6] } });

    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(11);
    doc.text(`Total Biaya Bahan: ${totalBiaya}`, 14, finalY);
    doc.text(`Jumlah Produksi: ${unit} unit`, 14, finalY + 6);
    
    doc.setFontSize(14);
    doc.setTextColor(217, 119, 6); doc.setFont("helvetica", "bold");
    doc.text(`HPP Per Unit: ${hpp}`, 14, finalY + 15);

    doc.save(`HPP_${namaProduk.replace(/\s+/g, '_')}.pdf`);
}

/* =========================================================================
   CALCULATOR NAVIGATION & SCROLL SPY
========================================================================= */
function scrollToSection(id) {
    const el = document.getElementById(id);
    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

window.addEventListener('scroll', () => {
    if(document.getElementById('tabKalkulator').classList.contains('hidden')) return;
    const sections = ['secBahan', 'secResep', 'secHasil', 'historyPanel'];
    const scrollPos = window.scrollY + 180; // Offset trigger
    sections.forEach(id => {
        const el = document.getElementById(id);
        if(el && el.offsetTop <= scrollPos && (el.offsetTop + el.offsetHeight) > scrollPos) {
            document.querySelectorAll('.calc-nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.calc-nav-btn[data-target="${id}"]`)?.classList.add('active');
        }
    });
});

/* =========================================================================
   RIWAYAT (HISTORY) LOGIC
========================================================================= */
let historyData = [];
const HISTORY_KEY = 'pastryPro_History';

function loadHistoryFromStorage() {
    try {
        const raw = localStorage.getItem(HISTORY_KEY);
        historyData = raw ? JSON.parse(raw) : [];
    } catch (e) { historyData = []; }
}

function saveHistory() {
    let totalBiaya = bahanKalkulator.reduce((sum, b) => sum + (b.hpp * (resepKalkulator[b.id] || 0)), 0);
    const jumlahUnit = parseFloat(document.getElementById('jumlahUnitKalkulator').value) || 1;
    const namaProduk = document.getElementById('namaProduk').value || 'Tanpa Nama';
    const hppPerUnit = totalBiaya / jumlahUnit;

    if (totalBiaya === 0) {
        return alert('Tidak ada yang bisa disimpan. Kalkulator masih kosong.');
    }

    const snapshot = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        namaProduk,
        totalBiaya,
        jumlahUnit,
        hppPerUnit,
        bahanKalkulator: JSON.parse(JSON.stringify(bahanKalkulator)),
        resepKalkulator: JSON.parse(JSON.stringify(resepKalkulator))
    };

    historyData.unshift(snapshot);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
    renderHistory();
    alert('Riwayat kalkulasi berhasil disimpan.');
}

function renderHistory() {
    const container = document.getElementById('historyList');
    if (!container) return;
    if (!historyData || historyData.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500">Belum ada riwayat tersimpan.</div>';
        return;
    }
    container.innerHTML = historyData.map(entry => `
        <div class="p-3 border rounded-lg flex justify-between items-center hover:bg-gray-50 transition">
            <div>
                <div class="font-semibold text-gray-800">${formatDateTime(entry.timestamp)}</div>
                <div class="text-sm text-gray-600"><span class="font-bold text-amber-600">${entry.namaProduk || 'Tanpa Nama'}</span> ‚Ä¢ HPP: Rp ${Math.round(entry.hppPerUnit).toLocaleString('id-ID')}</div>
            </div>
            <div class="flex gap-2">
                <button onclick="loadHistoryEntry(${entry.id})" class="px-3 py-1.5 bg-blue-500 text-white rounded-md font-medium text-sm hover:bg-blue-600">Buka</button>
                <button onclick="deleteHistoryEntry(${entry.id})" class="px-3 py-1.5 bg-red-100 text-red-600 rounded-md font-medium text-sm hover:bg-red-200">Hapus</button>
            </div>
        </div>
    `).join('');
}

function clearHistory() {
    if (!confirm('Apakah Anda yakin ingin menghapus semua riwayat? Tindakan ini tidak bisa dibatalkan.')) return;
    historyData = [];
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
}

function deleteHistoryEntry(id) {
    if (!confirm('Hapus riwayat ini?')) return;
    historyData = historyData.filter(e => e.id !== id);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(historyData));
    renderHistory();
}

function loadHistoryEntry(id) {
    const entry = historyData.find(e => e.id === id);
    if (!entry) { alert('Riwayat tidak ditemukan.'); return; }
    if (!confirm('Muat riwayat ini? Data di kalkulator saat ini akan diganti.')) return;
    
    bahanKalkulator = JSON.parse(JSON.stringify(entry.bahanKalkulator));
    resepKalkulator = JSON.parse(JSON.stringify(entry.resepKalkulator));
    document.getElementById('jumlahUnitKalkulator').value = entry.jumlahUnit || '';
    document.getElementById('namaProduk').value = entry.namaProduk || '';
    
    renderKalkulator();
    document.getElementById('tabKalkulator').scrollIntoView({ behavior: 'smooth' });
}

function formatDateTime(iso) {
    const d = new Date(iso);
    return d.toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

/* =========================================================================
   SISTEM TIMER MULTI-ALARM
========================================================================= */
// Alias util
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const getVal = el => Math.round(el.scrollTop / 40);

// Timer State
let tState = { alarms: [], quick: { totalMs:0, remainingMs:0, run:false, ring:false, end:null }};
let ringInt = new Map();
let audioCtx = null;

function renderTimerNav() {
    $$('.nav-item-timer').forEach(btn => {
        btn.onclick = () => {
            $$('.page-timer').forEach(p => p.classList.add('hidden'));
            $$('.nav-item-timer').forEach(b => b.classList.remove('active'));
            let targetId = btn.dataset.nav.charAt(0).toUpperCase() + btn.dataset.nav.slice(1);
            $('#page' + targetId).classList.remove('hidden');
            btn.classList.add('active');
        }
    });
}

// Picker Scroll
function setupPicker(el, max, def=0) {
    if(!el) return;
    el.innerHTML = '<div style="height:40px"></div>';
    for(let i=0; i<=max; i++) {
        let d = document.createElement('div'); d.className='scroll-picker-item'; d.innerText=String(i).padStart(2,'0'); el.appendChild(d);
    }
    el.innerHTML += '<div style="height:40px"></div>';
    setTimeout(() => { el.scrollTop = def*40; checkActivePicker(el); }, 50);
    el.onscroll = () => checkActivePicker(el);
}
function checkActivePicker(el) {
    let c = Math.round(el.scrollTop / 40);
    $$('.scroll-picker-item', el).forEach((item, i) => item.classList.toggle('active', i === c));
}

// Audio Engine
function initAudio() {
    if(audioCtx) return audioCtx;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(Ctx) audioCtx = new Ctx();
    return audioCtx;
}
function playBeep() {
    let ctx = initAudio(); if(!ctx) return;
    if(ctx.state === 'suspended') ctx.resume();
    let o = ctx.createOscillator(); o.type = 'square'; o.frequency.value = 1046;
    let g = ctx.createGain(); g.gain.setValueAtTime(0.1, ctx.currentTime);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.1);
}
function startRinging(id) {
    if(ringInt.has(id)) clearInterval(ringInt.get(id));
    playBeep();
    let iv = setInterval(playBeep, 1000);
    ringInt.set(id, iv);
}
function stopRinging(id) {
    if(ringInt.has(id)) { clearInterval(ringInt.get(id)); ringInt.delete(id); }
}

// Core Timer Ticking
function tickAll() {
    let now = Date.now();
    // Quick
    if(tState.quick.run) {
        tState.quick.remainingMs = Math.max(0, tState.quick.end - now);
        if(tState.quick.remainingMs === 0) {
            tState.quick.run = false; tState.quick.ring = true; startRinging('quick');
        }
        updateQuickUI();
    }
    // Multi
    tState.alarms.forEach(a => {
        if(a.run) {
            a.rem = Math.max(0, a.end - now);
            if(a.rem === 0) { a.run = false; a.ring = true; startRinging(a.id); updateMultiUI(); }
            // Live update text
            let card = $(`[data-id="${a.id}"]`);
            if(card) {
                $('.time-disp', card).textContent = formatTimeStr(a.rem);
                let pct = a.dur ? (1 - a.rem/a.dur)*100 : 0;
                $('.bar-fill', card).style.width = pct + '%';
            }
        }
    });
}
function formatTimeStr(ms) {
    let s = Math.ceil(ms/1000); let h = Math.floor(s/3600); let m = Math.floor((s%3600)/60); s = s%60;
    return (h?String(h).padStart(2,'0')+':':'') + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}

// Quick UI
function updateQuickUI() {
    $('#quickDisplay').textContent = formatTimeStr(tState.quick.remainingMs);
    let pct = tState.quick.totalMs ? (1 - tState.quick.remainingMs/tState.quick.totalMs)*100 : 0;
    $('#quickBar').style.width = pct + '%';
    
    $('#quickStart').classList.toggle('hidden', tState.quick.run);
    $('#quickPause').classList.toggle('hidden', !tState.quick.run);
    
    if(tState.quick.ring) { $('#quickTimerCard').classList.add('ringPulse'); $('#quickStop').classList.remove('hidden'); }
    else { $('#quickTimerCard').classList.remove('ringPulse'); $('#quickStop').classList.add('hidden'); }
}
$$('.quick-add').forEach(b => b.onclick = () => {
    let sec = parseInt(b.dataset.sec)*1000;
    tState.quick.totalMs += sec; tState.quick.remainingMs += sec;
    if(tState.quick.run) tState.quick.end = Date.now() + tState.quick.remainingMs;
    updateQuickUI();
});
$('#quickStart').onclick = () => { if(tState.quick.remainingMs>0){ tState.quick.run=true; tState.quick.ring=false; stopRinging('quick'); tState.quick.end = Date.now()+tState.quick.remainingMs; updateQuickUI();} }
$('#quickPause').onclick = () => { tState.quick.run=false; updateQuickUI(); }
$('#quickReset').onclick = () => { tState.quick.run=false; tState.quick.ring=false; stopRinging('quick'); tState.quick.totalMs=0; tState.quick.remainingMs=0; updateQuickUI(); }
$('#quickStop').onclick = () => { tState.quick.ring=false; stopRinging('quick'); updateQuickUI(); }

// Multi UI
$('#btnAddTimer').onclick = () => {
    let ms = ((getVal($('#pickH'))*3600) + (getVal($('#pickM'))*60) + getVal($('#pickS'))) * 1000;
    if(ms < 1000) return;
    tState.alarms.push({ id: Date.now(), name: $('#inName').value || 'Timer', cat: $('#inCategory').value, theme: $('#inTheme').value, dur: ms, rem: ms, run: false, ring: false });
    updateMultiUI();
}
function updateMultiUI() {
    let list = $('#timerList');
    if(!tState.alarms.length) { $('#emptyTimer').classList.remove('hidden'); list.innerHTML=''; return; }
    $('#emptyTimer').classList.add('hidden');
    
    const thm = { vanilla: 'bg-amber-100', choco: 'bg-orange-100', strawberry: 'bg-pink-100' };
    
    list.innerHTML = tState.alarms.map(a => `
        <div class="glass p-4 rounded-xl border ${thm[a.theme]||'bg-white'} ${a.ring?'ringPulse border-red-400':''}" data-id="${a.id}">
            <div class="flex justify-between font-bold mb-2"><span>${a.name} <span class="text-xs font-normal bg-white px-2 rounded-full">${a.cat}</span></span> <button onclick="delTimer(${a.id})" class="text-red-500">√ó</button></div>
            <div class="time-disp text-3xl font-black mb-2">${formatTimeStr(a.rem)}</div>
            <div class="h-2 rounded-full bg-black/10 mb-3"><div class="bar-fill h-full bg-amber-500" style="width:${a.dur?(1-a.rem/a.dur)*100:0}%"></div></div>
            <div class="flex gap-2">
                ${a.run ? `<button onclick="pauseTimer(${a.id})" class="flex-1 bg-white rounded font-bold py-1">Pause</button>` 
                        : `<button onclick="startTimer(${a.id})" class="flex-1 bg-amber-500 text-white rounded font-bold py-1">Start</button>`}
                <button onclick="resTimer(${a.id})" class="flex-1 bg-white rounded font-bold py-1">Reset</button>
                ${a.ring ? `<button onclick="stopRing(${a.id})" class="flex-1 bg-red-500 text-white rounded font-bold py-1">Stop</button>`:''}
            </div>
        </div>
    `).join('');
}
window.startTimer = (id) => { let a=tState.alarms.find(x=>x.id===id); if(a){ a.run=true; a.ring=false; stopRinging(id); a.end=Date.now()+a.rem; updateMultiUI(); }};
window.pauseTimer = (id) => { let a=tState.alarms.find(x=>x.id===id); if(a){ a.run=false; updateMultiUI(); }};
window.resTimer = (id) => { let a=tState.alarms.find(x=>x.id===id); if(a){ a.run=false; a.ring=false; stopRinging(id); a.rem=a.dur; updateMultiUI(); }};
window.delTimer = (id) => { stopRinging(id); tState.alarms = tState.alarms.filter(x=>x.id!==id); updateMultiUI(); };
window.stopRing = (id) => { stopRinging(id); let a=tState.alarms.find(x=>x.id===id); if(a){ a.ring=false; updateMultiUI(); }};

$('#btnStopAll').onclick = () => { 
    stopRinging('quick'); tState.quick.ring=false;
    tState.alarms.forEach(a => { stopRinging(a.id); a.ring = false; });
    updateQuickUI(); updateMultiUI();
}

// Kalkulator Timer Khusus
let cDis='0', cOp=null, cPrev=null, cNew=true;
$$('.calc-btn').forEach(btn => btn.onclick = () => {
    let v = btn.dataset.calc;
    if(v>='0'&&v<='9') { if(cNew){cDis=v; cNew=false;} else{ cDis = cDis==='0'?v:cDis+v; } }
    else if(v==='.') { if(!cDis.includes('.')) cDis+='.'; cNew=false; }
    else if(v==='C') { cDis='0'; cPrev=null; cOp=null; cNew=true; }
    else if(v==='¬±') cDis=String(-parseFloat(cDis));
    else if(v==='%') cDis=String(parseFloat(cDis)/100);
    else if(['+','-','*','/'].includes(v)) {
        if(cPrev!==null && cOp && !cNew) { cPrev = eval(`${cPrev}${cOp}${parseFloat(cDis)}`); cDis=String(cPrev); }
        else { cPrev = parseFloat(cDis); }
        cOp=v; cNew=true;
    }
    else if(v==='=') { if(cPrev!==null && cOp) { cDis=String(eval(`${cPrev}${cOp}${parseFloat(cDis)}`)); cPrev=null; cOp=null; cNew=true; } }
    $('#calcDisplay').value = cDis;
});

/* =========================================================================
   BOOTSTRAP APP
========================================================================= */
function initApp() {
    loadMasterDB();
    for(let i=0; i<3; i++) tambahBahanKalkulator();
    renderKalkulator();
    
    loadHistoryFromStorage();
    renderHistory();
    
    setupPicker($('#pickH'), 23, 0); setupPicker($('#pickM'), 59, 20); setupPicker($('#pickS'), 59, 0);
    renderTimerNav();
    setInterval(tickAll, 250);
}

// Inisialisasi awal saat load
renderTimerNav();
</script>
</body>
</html>